machine:
  ruby:
    version: 2.1.2
  services:
    - docker

dependencies:
  override:
    - sudo pip install git+http://github.com/btaitelb/fig.git@tail
    - fig up -d

database:
  override:
    - echo 'skipping inferred commands'

test:
  override:
    - fig run app bundle exec rake
  post:
    - fig logs > ${CIRCLE_ARTIFACTS}/fig.log
    - cp log/* ${CIRCLE_ARTIFACTS}
    
deployment:
  hub:
    branch: master
    commands:
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p "${DOCKER_PASS}"
      - echo "output of 'fig ps' is: "
      - fig ps
      - echo "output of 'fig ps | grep Up | cut -d ' ' -f 1' is: "
      - fig ps | grep Up | cut -d ' ' -f 1
      - echo "output of 'fig ... | sed' is: "
      - fig ps | grep Up | cut -d ' ' -f 1 | sed -r 's/_[0-9]+$//'
      - echo "last command but in a bash shell: "
      - bash -c "fig ps | grep Up | cut -d ' ' -f 1 | sed -r 's/_[0-9]+$//'"
      - for image in `fig ps | grep Up | cut -d ' ' -f 1 | sed -r 's/_[0-9]+$//'`; do SHA=${CIRCLE_SHA1:0:7}; IMG="${CIRCLE_PROJECT_USERNAME}/$image:$SHA"; echo "Tagging $image:latest as $IMG"; docker tag $image:latest $IMG; echo "pushing $IMG"; docker push $IMG; done
